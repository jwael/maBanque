import org.apache.tika.parser.txt.UniversalDetector
import org.springframework.web.multipart.MultipartFile
import java.io.ByteArrayInputStream
import java.io.InputStreamReader
import java.nio.charset.Charset
import java.nio.charset.StandardCharsets

class CaixaCsvParser {

    // toUtf8Reader adaptée à la signature de la classe mère, avec logs et nettoyage
    fun toUtf8Reader(file: MultipartFile): InputStreamReader {
        println("=== Début toUtf8Reader ===")
        val fileBytes = file.bytes
        println("Taille du fichier: ${fileBytes.size} bytes")

        val detectedEncoding = detectEncoding(fileBytes)
        println("Encodage détecté: $detectedEncoding")

        val utf8Bytes = if (detectedEncoding == "UTF-8") {
            println("Encodage déjà UTF-8, utilisation des bytes originaux")
            fileBytes
        } else {
            println("Conversion nécessaire depuis $detectedEncoding vers UTF-8")
            convertToUtf8(file, detectedEncoding)
        }

        val cleanedBytes = cleanExcelHeaders(utf8Bytes)
        println("Nettoyage Excel terminé")
        println("=== Fin toUtf8Reader ===")

        return InputStreamReader(ByteArrayInputStream(cleanedBytes), StandardCharsets.UTF_8)
    }

    // Vérifie que le fichier n'est pas au format CSV
    fun hasNotCsvFormat(file: MultipartFile) = file.contentType != "text/csv" &&
                                              file.contentType != "application/vnd.ms-excel" &&
                                              !file.originalFilename?.endsWith(".csv", ignoreCase = true)!!

    // Détection d'encodage
    private fun detectEncoding(fileBytes: ByteArray): String {
        println("Début détection encodage")
        val detector = UniversalDetector(null) // listener nul
        detector.handleData(fileBytes, 0, fileBytes.size)
        detector.dataEnd()
        val detected = detector.detectedCharset ?: "UTF-8"
        println("Encodage détecté: $detected")
        detector.reset()
        return detected
    }

    // Conversion explicite en UTF-8
    private fun convertToUtf8(file: MultipartFile, originalEncoding: String): ByteArray {
        println("Conversion de $originalEncoding vers UTF-8")
        return String(file.bytes, Charset.forName(originalEncoding))
            .toByteArray(StandardCharsets.UTF_8)
    }

    // Nettoyage des headers Excel ou BOM
    private fun cleanExcelHeaders(bytes: ByteArray): ByteArray {
        println("Début nettoyage headers Excel")
        var content = String(bytes, StandardCharsets.UTF_8)

        content = content
            .replace("\uFEFF", "")
            .replace("\uFFFE", "")
            .replace("ï»¿", "")
            .trim()

        val excelHeaders = listOf("sep=.*?\n")
        excelHeaders.forEach { pattern ->
            content = content.replace(Regex(pattern), "")
        }

        content = content.trimStart()
        println("Fin nettoyage headers Excel")
        return content.toByteArray(StandardCharsets.UTF_8)
    }
}