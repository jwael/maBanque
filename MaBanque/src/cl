package com.arval.blm.infrastructure.driving.rest.common

import org.apache.commons.fileupload.disk.DiskFileItem
import org.mozilla.universalchardet.UniversalDetector
import org.springframework.web.multipart.MultipartFile
import java.io.ByteArrayInputStream
import java.io.InputStreamReader
import java.nio.charset.Charset
import java.nio.charset.StandardCharsets

object OpenCsvUtils {

    fun toUtf8Reader(file: MultipartFile): InputStreamReader {
        val fileBytes = file.bytes
        println("File byte size: ${fileBytes.size}")

        val detectedEncoding = detectEncoding(fileBytes)
        println("Detected encoding: $detectedEncoding")

        val utf8Bytes = if (detectedEncoding.equals("UTF-8", ignoreCase = true)) {
            file.bytes
        } else {
            convertToUtf8(file, originalEncoding = detectedEncoding)
        }
        println("Byte size after UTF-8 conversion: ${utf8Bytes.size}")

        return InputStreamReader(ByteArrayInputStream(utf8Bytes), StandardCharsets.UTF_8)
    }

    fun hasNotCsvFormat(file: MultipartFile) = file.contentType != "text/csv"

    private fun detectEncoding(fileBytes: ByteArray): String {
        val detector = UniversalDetector(null)
        detector.handleData(fileBytes, 0, fileBytes.size)
        detector.dataEnd()
        val charset = detector.detectedCharset ?: "ISO-8859-1"
        println("UniversalDetector detected charset: ${detector.detectedCharset}")
        println("Using detected encoding: $charset")
        return charset
    }

    private fun convertToUtf8(file: MultipartFile, originalEncoding: String): ByteArray {
        println("Converting file from $originalEncoding to UTF-8")
        return String(file.bytes, Charset.forName(originalEncoding)).toByteArray(StandardCharsets.UTF_8)
    }

    /**
     * Clean CSV header by removing non-printable or invisible characters added by Excel.
     */
    fun cleanCsvHeader(headerLine: String): String {
        val cleaned = headerLine.replace(Regex("[^\\p{Print};]"), "")
        println("Original header: '$headerLine'")
        println("Cleaned header:  '$cleaned'")
        return cleaned
    }
}