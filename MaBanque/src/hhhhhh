import org.apache.tika.parser.txt.UniversalDetector
import org.springframework.web.multipart.MultipartFile
import java.io.ByteArrayInputStream
import java.io.InputStreamReader
import java.nio.charset.Charset
import java.nio.charset.StandardCharsets

class CaixaCsvParser {

    fun toUtf8Reader(file: MultipartFile): InputStreamReader {
        println("=== Début toUtf8Reader ===")
        val fileBytes = file.bytes
        println("Taille du fichier: ${fileBytes.size} bytes")
        
        val detectedEncoding = detectEncoding(fileBytes)
        println("Encodage détecté: $detectedEncoding")
        
        val utf8Bytes = if (detectedEncoding.equals("UTF-8", ignoreCase = true)) {
            println("Encodage déjà UTF-8, utilisation des bytes originaux")
            fileBytes
        } else {
            println("Conversion nécessaire depuis $detectedEncoding vers UTF-8")
            convertToUtf8(fileBytes, detectedEncoding)
        }
        
        val cleanedBytes = cleanBOM(utf8Bytes)
        println("Nettoyage BOM terminé")
        println("=== Fin toUtf8Reader ===")
        
        return InputStreamReader(ByteArrayInputStream(cleanedBytes), StandardCharsets.UTF_8)
    }

    fun hasNotCsvFormat(file: MultipartFile): Boolean {
        println("Vérification format CSV - ContentType: ${file.contentType}, Filename: ${file.originalFilename}")
        val result = file.contentType != "text/csv"
        println("Résultat vérification format: $result")
        return result
    }

    private fun detectEncoding(fileBytes: ByteArray): String {
        println("Début détection encodage")
        val detector = UniversalDetector(null)
        return try {
            detector.handleData