package com.arval.blm.core.application.service

import com.arval.blm.core.domain.model.LoaderBatch
import com.arval.blm.core.domain.model.LoaderBatchStatus
import com.arval.blm.core.domain.model.LoaderBatchType
import com.arval.blm.core.domain.model.customer.CustomerPayload
import com.arval.blm.core.domain.model.customer.crm.CrmClsCustomerData
import com.arval.blm.core.domain.spi.crm.CrmClsCustomerDataRepositorySpi
import com.arval.blm.core.domain.spi.batch.BatchRepositoryForContactsSpi
import com.arval.blm.core.domain.spi.event.RecordStepEventRepositorySpi
import com.arval.blm.core.domain.spi.crm.CrmCustomerProviderSpi
import io.mockk.*
import kotlinx.coroutines.test.runTest
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Nested
import org.junit.jupiter.api.Test
import java.time.Instant
import java.util.stream.IntStream

class ImportCustomersServiceTest {

    private val recordStepEventRepositorySpi = mockk<RecordStepEventRepositorySpi>(relaxed = true)
    private val crmClsCustomerDataRepositorySpi = mockk<CrmClsCustomerDataRepositorySpi>(relaxed = true)
    private val crmCustomerProviderSpi = mockk<CrmCustomerProviderSpi>(relaxed = true)
    private val batchRepositorySpi = mockk<BatchRepositoryForContactsSpi>(relaxed = true)

    private lateinit var importCustomerService: ImportCustomersService

    private val newBatch = LoaderBatch(
        id = "AAAAA",
        reference = "BATCH_REF",
        fileName = "file.csv",
        triggeredBy = "u0001",
        countryCode = "FR",
        status = LoaderBatchStatus.RUNNING,
        startDate = Instant.now(),
        endDate = Instant.now(),
        totalContacts = 1,
        type = LoaderBatchType.CONTACTS
    )

    private val personalAccounts = IntStream.range(0, 1).mapToObj {
        CustomerPayload(
            rowNumber = it,
            errorMessage = "OK",
            crmData = mapOf("salesforceRoleId" to null)
        )
    }.toList()

    @BeforeEach
    fun setup() {
        importCustomerService = spyk(
            ImportCustomersService(
                recordStepEventRepositorySpi,
                crmClsCustomerDataRepositorySpi,
                crmCustomerProviderSpi,
                batchRepositorySpi
            )
        )
    }

    @Nested
    inner class Apply {

        @Test
        fun `should save customer data successfully`() = runTest {
            // Given
            val fakeCustomerData = mockk<CrmClsCustomerData>(relaxed = true)
            every {
                importCustomerService["createCrmClsCustomerData"](any<LoaderBatch>(), any<CustomerPayload>())
            } returns fakeCustomerData

            every {
                importCustomerService["processCustomerSavingInBlmStep"](any<CrmClsCustomerData>())
            } returns fakeCustomerData

            every {
                crmClsCustomerDataRepositorySpi.save(any())
            } returns fakeCustomerData

            // When
            importCustomerService.apply(newBatch, personalAccounts)

            // Then
            verify(exactly = 1) {
                crmClsCustomerDataRepositorySpi.save(any())
            }
        }
    }
}