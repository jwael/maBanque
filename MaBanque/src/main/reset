import org.apache.tika.parser.txt.UniversalDetector
import org.springframework.web.multipart.MultipartFile
import java.io.BufferedReader
import java.io.ByteArrayInputStream
import java.io.InputStreamReader
import java.nio.charset.StandardCharsets

object OpenCsvUtils {

    fun toUtf8Reader(file: MultipartFile): InputStreamReader {
        val detectedEncoding = detectEncoding(file.bytes)
        println("[DEBUG] detectEncoding -> Charset détecté : $detectedEncoding")

        val utf8Bytes = if (detectedEncoding == "UTF-8") {
            file.bytes
        } else {
            convertToUtf8(file, originalEncoding = detectedEncoding)
        }

        println("[DEBUG] Charset final utilisé = UTF-8")
        println("[DEBUG] Taille du flux = ${utf8Bytes.size}")

        val inputStream = ByteArrayInputStream(utf8Bytes)
        val reader = InputStreamReader(inputStream, StandardCharsets.UTF_8)
        val buffered = BufferedReader(reader)

        // Vérifie et consomme le BOM si présent
        buffered.mark(1)
        val firstChar = buffered.read()
        if (firstChar != 0xFEFF) {
            buffered.reset()
        } else {
            println("[DEBUG] BOM détecté et supprimé")
        }

        return InputStreamReader(buffered, StandardCharsets.UTF_8)
    }

    private fun detectEncoding(fileBytes: ByteArray): String {
        val detector = UniversalDetector(null)
        detector.handleData(fileBytes, 0, fileBytes.size)
        detector.dataEnd()
        return detector.detectedCharset ?: "UTF-8"
    }

    private fun convertToUtf8(file: MultipartFile, originalEncoding: String): ByteArray {
        println("[DEBUG] Conversion en UTF-8 depuis $originalEncoding")
        return String(file.bytes, charset(originalEncoding)).toByteArray(StandardCharsets.UTF_8)
    }
}