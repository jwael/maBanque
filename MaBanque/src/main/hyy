@Test
fun `it should process customer update correctly`() {
    // GIVEN
    val crmCustomerResponsePayload = CrmCustomerResponsePayload(
        crmAccountId = "ACC123",
        crmStatus = RecordStepStatus.OK,
        crmMessage = "Customer updated",
        crmRoleId = null
    )

    val crmClsCustomerData = CrmClsCustomerData(
        batchId = batch.id!!,
        reconciliationId = ReconciliationId(batchReference = batch.reference, rowReference = ReferenceId("ROW0010001")),
        rowNumber = 1,
        rowReference = ReferenceId("ROW0010001"),
        crmData = CrmData(
            firstName = "Antoine",
            surname = "Dupont",
            contactRole = "prospect",
            mainCountry = "FR"
        ),
        clsData = emptyMap(),
        id = "CUST001",
        crmInsertedId = null
    )

    every { crmCustomerProviderSpi.updateCrmCustomer(any()) } returns crmCustomerResponsePayload
    every { crmClsCustomerDataRepositorySpi.save(any()) } answers { firstArg() }
    every { recordStepEventRepositorySpi.save(any()) } answers { firstArg() }

    // WHEN
    importCustomerService.apply(batch, listOf(
        CustomerPayload(
            rowNumber = crmClsCustomerData.rowNumber,
            crmData = crmClsCustomerData.crmData,
            clsData = crmClsCustomerData.clsData
        )
    ))

    // THEN
    // Capturer tous les enregistrements
    val savedCustomers = mutableListOf<CrmClsCustomerData>()
    verify { crmClsCustomerDataRepositorySpi.save(capture(savedCustomers)) }

    val savedCustomer = savedCustomers.find { it.crmInsertedId == "ACC123" }
    assertNotNull(savedCustomer, "Customer with CRM account ID should have been saved")
    assertEquals("BATCH_1", savedCustomer!!.batchId)

    // Capturer tous les RecordStepEvent
    val stepEvents = mutableListOf<RecordStepEvent>()
    verify { recordStepEventRepositorySpi.save(capture(stepEvents)) }

    // Chercher l'Ã©tape SF_UPDATE
    val sfUpdateEvent = stepEvents.find { it.stepName == SF_UPDATE }
    assertNotNull(sfUpdateEvent, "SF_UPDATE step should have been created")
    assertEquals(RecordStepStatus.OK, sfUpdateEvent!!.stepStatus)
    assertEquals("Customer updated", sfUpdateEvent.stepMessage)
}